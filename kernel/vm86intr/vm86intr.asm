[ORG 0x4000]

[BITS 64]
CLI
MOV QWORD [origRSP],RSP
MOV AX,0x20
MOV SS,AX
MOV DS,AX
MOV ES,AX
MOV FS,AX
MOV GS,AX
PUSH QWORD 0x8
PUSH QWORD LM1
DB 0x48 ;; Bug in NASM compiler
RETF
LM1:
[BITS 16]
MOV EAX,CR0
XOR EAX,0x80000000
MOV CR0,EAX
XOR EBX,EBX
MOV BX,0x10
MOV DS,BX
MOV ES,BX
MOV FS,BX
MOV GS,BX
MOV SS,BX
DEC EAX
MOV CR0,EAX

JMP 0:RM2
RM2:
MOV ESP,0x3FEA
XOR EAX,EAX
MOV DS,AX
MOV ES,AX
MOV FS,AX
MOV GS,AX
MOV SS,AX
XOR EBX,EBX
XOR ECX,ECX
XOR EDX,EDX
XOR EBP,EBP
XOR ESI,ESI
XOR EDI,EDI
;; Disable APIC

;; Set up rmode 8259 / IDT
LIDT [0x5000]
MOV DX,0x21
MOV AL,[0x5020]
OUT DX,AL
MOV DX,0xA1
MOV AL,[0x5021]
OUT DX,AL
STI

POP AX
MOV [intNo],AL
POPA
POP DS
POP ES

;; Interrupt call
DB 0xCD
intNo:
DB 0xFF

PUSH DWORD 0
PUSHA

CLI
;; Turn back off 8259
MOV DX,0x21
MOV AL,0xff
OUT DX,AL
MOV DX,0xA1
OUT DX,AL
MOV EAX,CR0
OR EAX,0x80000001
MOV DWORD ESP,[origRSP]
MOV CR0,EAX
JMP 0x18:b32
[BITS 32]
b32:
MOV EAX,0x30
MOV DS,AX
MOV ES,AX
MOV FS,AX
MOV GS,AX
MOV SS,AX
JMP 0x28:RtrnTo
[BITS 64]
RtrnTo:
RET

;; Data section
origRSP DQ 0
